"""
MercadinhoSys API - Aplica√ß√£o Flaskssional
Arquitetura modular com blueprints por funcionalidade
"""
from .orchestration import DashboardOrchestrator
from flask import Flask, jsonify, request, current_app
from flask_migrate import Migrate
from flask_cors import CORS
from flask_jwt_extended import JWTManager
from flask_caching import Cache
from flask_mail import Mail
from app.models import db
from config import config
import os
import logging# Inicializa as extens√µesmigrate = Migrate()jwt = JWTManager()cache = Cache()mail = Mail()# Middleware e utilit√°riosfrom app.middleware.rate_limit import limiterfrom app.utils.logger import setup_logger# Configura loggerlogger = setup_logger(__name__)def create_app(config_name=None):    """Factory function para criar a aplica√ß√£o Flask"""    # Determina configura√ß√£o padr√£o    if config_name is None:        config_name = os.getenv("FLASK_ENV", "default")    app = Flask(__name__)    # Middleware global para preflight CORS    @app.before_request    def handle_options_preflight():        if request.method == "OPTIONS":            response = app.make_default_options_response()            return response    # Carrega configura√ß√µes    app.config.from_object(config[config_name])    # Configura√ß√£o do Cache    if "CACHE_TYPE" not in app.config:        app.config["CACHE_TYPE"] = "simple"        app.config["CACHE_DEFAULT_TIMEOUT"] = 300    # Inicializa extens√µes com o app    db.init_app(app)    migrate.init_app(app, db)    jwt.init_app(app)    cache.init_app(app)    mail.init_app(app)    # Inicializa rate limiter    limiter.init_app(app)    # Configura√ß√£o CORS    CORS(        app,        resources={r"/api/*": {"origins": "*"}},        supports_credentials=True,        allow_headers=["Content-Type", "Authorization", "X-Requested-With"],        methods=["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"],    )    # Cria pasta de uploads se n√£o existir    upload_folder = app.config.get("UPLOAD_FOLDER", "instance/uploads")    if not os.path.exists(upload_folder):        os.makedirs(upload_folder)    # Cria pasta instance se n√£o existir    if not os.path.exists("instance"):        os.makedirs("instance")    # Registra blueprints principais    from app.routes import (        auth,        produtos,        fornecedores,        funcionarios,        clientes,        vendas,        pdv,        configuracao,        dashboard,        despesas,        relatorios,    )    # Blueprints principais com prefixos    app.register_blueprint(auth.bp, url_prefix="/api/auth")    app.register_blueprint(produtos.bp, url_prefix="/api/produtos")    app.register_blueprint(fornecedores.bp, url_prefix="/api/fornecedores")    app.register_blueprint(funcionarios.bp, url_prefix="/api/funcionarios")    app.register_blueprint(clientes.bp, url_prefix="/api/clientes")    app.register_blueprint(vendas.bp, url_prefix="/api/vendas")    app.register_blueprint(pdv.bp, url_prefix="/api/pdv")    app.register_blueprint(configuracao.bp, url_prefix="/api/config")    app.register_blueprint(dashboard.bp, url_prefix="/api/dashboard")    app.register_blueprint(despesas.bp, url_prefix="/api/despesas")    app.register_blueprint(relatorios.bp, url_prefix="/api/relatorios")    # Dashboard Cient√≠fico (opcional)    try:        from app.routes.dashboard_cientifico import cientifico_bp        app.register_blueprint(cientifico_bp, url_prefix="/api/cientifico")        dashboard_cientifico_disponivel = True        logger.info("‚úÖ Dashboard Cient√≠fico carregado em /api/cientifico")    except ImportError as e:        dashboard_cientifico_disponivel = False        logger.warning(f"‚ö†Ô∏è Dashboard Cient√≠fico n√£o dispon√≠vel: {str(e)[:100]}...")    except Exception as e:        dashboard_cientifico_disponivel = False        logger.error(f"‚ùå Erro ao carregar Dashboard Cient√≠fico: {e}")    # üìä Rota de sa√∫de do sistema    @app.route("/api/health", methods=["GET"])    def health_check():        """Endpoint de sa√∫de da API"""        from sqlalchemy import text        from datetime import datetime        try:            # Testa conex√£o com banco            db.session.execute(text("SELECT 1"))            db_status = "connected"            db_error = None        except Exception as e:            db_status = "disconnected"            db_error = str(e)        # Coleta informa√ß√µes do sistema        health_info = {            "status": "healthy" if db_status == "connected" else "degraded",            "service": "MercadinhoSys API",            "version": "2.0.0",            "timestamp": datetime.now().isoformat(),            "environment": config_name,            "database": {                "status": db_status,                "error": db_error,                "dialect": (                    str(db.engine.url.drivername)                    if hasattr(db, "engine")                    else "unknown"                ),            },            "features": {                "dashboard_cientifico": dashboard_cientifico_disponivel,                "caching": app.config.get("CACHE_TYPE", "none") != "null",                "authentication": True,                "rate_limiting": True,            },            "endpoints": [                "/api/auth/login",                "/api/produtos",                "/api/vendas",                "/api/dashboard",                "/api/pdv",                "/api/relatorios",            ],        }        status_code = 200 if db_status == "connected" else 503        return jsonify(health_info), status_code    # üè† Rota inicial/documenta√ß√£o    @app.route("/", methods=["GET"])    @app.route("/api", methods=["GET"])    def index():        """Rota inicial da API"""        return jsonify(            {                "message": "üöÄ MercadinhoSys API - Sistema de Gest√£o para Mercados",                "version": "2.0.0",                "status": "operational",                "documentation": {                    "swagger": (                        "/api/swagger"                        if app.config.get("SWAGGER_ENABLED", False)                        else "disabled"                    ),                    "postman": (                        "/api/postman"                        if app.config.get("EXPORT_POSTMAN", False)                        else "disabled"                    ),                },                "modules": {                    "auth": "/api/auth",                    "products": "/api/produtos",                    "sales": "/api/vendas",                    "dashboard": "/api/dashboard",                    "pdv": "/api/pdv",                    "reports": "/api/relatorios",                    "scientific": (                        "/api/cientifico"                        if dashboard_cientifico_disponivel                        else "not_available"                    ),                },                "health_check": "/api/health",            }        )    # üõ°Ô∏è Manipuladores de erro globais    @app.errorhandler(404)    def not_found(error):        return (            jsonify(                {                    "error": "Recurso n√£o encontrado",                    "path": request.path,                    "method": request.method,                    "timestamp": datetime.now().isoformat(),                    "suggestion": "Verifique a documenta√ß√£o em /api",                }            ),            404,        )    @app.errorhandler(405)    def method_not_allowed(error):        return (            jsonify(                {                    "error": "M√©todo n√£o permitido",                    "path": request.path,                    "method": request.method,                    "allowed_methods": (                        error.valid_methods if hasattr(error, "valid_methods") else []                    ),                    "timestamp": datetime.now().isoformat(),                }            ),            405,        )    @app.errorhandler(500)    def internal_error(error):        logger.error(f"Erro interno no servidor: {error}")        return (            jsonify(                {                    "error": "Erro interno do servidor",                    "message": "O servi√ßo est√° temporariamente indispon√≠vel",                    "timestamp": datetime.now().isoformat(),                    "request_id": request.headers.get("X-Request-ID", "none"),                }            ),            500,        )    # Log de inicializa√ß√£o bem-sucedida    logger.info(        f"""    {'='*60}    MercadinhoSys API v2.0.0 INICIALIZADA    Ambiente: {config_name}    Banco de dados: {app.config.get('SQLALCHEMY_DATABASE_URI', 'SQLite')}    Dashboard Cient√≠fico: {'‚úÖ Dispon√≠vel' if dashboard_cientifico_disponivel else '‚ö†Ô∏è N√£o dispon√≠vel'}    {'='*60}    """    )    return app